# UberFix.shop Audit Summary

## نطاق المراجعة
مراجعة سريعة للمخاطر الأمنية والخصوصية في وظائف Supabase والتهيئة الأمامية التي تؤثر على مفاتيح الطرف الثالث وبيانات المستخدمين. لم يتم تشغيل اختبارات أو بناء التطبيق في هذه الجولة.

## أهم الملاحظات
1) **تسريب مفتاح Google Maps في الواجهة**  
   يوجد مفتاح Google Maps فعّال مستخدم كقيمة احتياطية في تهيئة الواجهة (`MAPS_CONFIG.apiKey`). أي بناء للعميل سيضمّن المفتاح مباشرة في الحزمة أو في تحميل السكربت، ما يسمح لأي زائر باستخدامه وإساءة استهلاكه. المفتاح يجب أن يكون محصوراً في خادم موثوق مع قيود نطاقات وعناوين IP. 【F:src/config/maps.ts†L6-L34】

2) **خدمتا get-maps-key / get-google-maps-key تكشفان المفتاح بلا تحقق**  
   وظيفتا الحافة تقومان بإرجاع مفتاح Google Maps على استدعاء HTTP عادي مع CORS مفتوح ودون مصادقة، ما يجعل أي عميل مجهول قادراً على سحب المفتاح حتى لو أُخفي في الواجهة. يجب تقييد الوصول (JWT للدور/التحكم بالصلاحيات) أو تنفيذ بروكسي خرائط آمن يحدّد الاستخدام. 【F:supabase/functions/get-maps-key/index.ts†L1-L47】【F:supabase/functions/get-google-maps-key/index.ts†L1-L32】

3) **نطاق وصول مفرط لقائمة المستخدمين**  
   وظيفة `get-users` تستخدم مفتاح الخدمة (SERVICE_ROLE) وتسمح لأي مستخدم مصادق عليه بقراءة قائمة جميع المستخدمين عبر واجهة `auth.admin.listUsers`. هذا يتجاوز مبدأ أقل الصلاحيات ويعرّض بيانات تعريف المستخدمين. يجب حصر الاستدعاء على دور إداري موثوق أو استبداله باستعلام محكوم بـ RLS من جدول عام غير حساس. 【F:supabase/functions/get-users/index.ts†L1-L55】

## توصيات عاجلة
- إزالة أي مفاتيح خرائط ثابتة من الواجهة، والاعتماد فقط على متغيرات بيئية مع تفعيل قيود الاستخدام من لوحة Google Cloud.
- حماية وظائف استرجاع المفاتيح بمصادقة واضحة (مثلاً التحقق من دور Admin أو نظام الخادم الداخلي) أو تقديم خدمة وسيطة تعيد نتائج الخرائط بدلاً من المفاتيح نفسها.
- مراجعة جميع وظائف Supabase التي تستخدم مفاتيح SERVICE_ROLE والتأكد من أنها مقصورة على مسارات إدارية موثوقة، مع تسجيل ومراقبة الاستخدام.

## نقاط متابعة
- تشغيل أداة فحص الأمان `scripts/test-security.sh` ضمن CI للتأكد من غياب مفاتيح أو سجلات تصحيحية مستقبلية.
- إضافة اختبارات تكامل توثق توقعات التحكم في الوصول لهذه الوظائف لمنع تراجع الأمان مستقبلًا.

## ما الذي يُفترض أن نركز عليه الآن؟
- **أولوية فحص الوظائف الأساسية حاليًا:** قبل الانتقال لأي اعتماد نهائي، يجب التأكد من أن مسارات الحجز/التسعير/الدفع تعمل بكاملها وفق سيناريوهات المستخدم الأساسية؛ أي خلل هنا سيعطل الإطلاق حتى لو كانت ثغرات الأمان متوسطة الخطورة.
- **فحص الأمان ليس مرحلة لاحقة فقط:** المخاطر الموثقة أعلاه (مفاتيح خرائط مكشوفة وصلاحيات خدمة زائدة) هي ثغرات إنتاجية قابلة للاستغلال فورًا حتى في بيئة الاختبار، لذا ينبغي معالجتها بالتوازي مع فحص الوظائف وعدم تأجيلها لما بعد التطوير.
- **ترتيب العمل المقترح:**
  1. تثبيت الوظائف الحرجة (حجوزات، حساب الأسعار، الدفع) عبر اختبارات يدوية وآلية.
  2. تنفيذ إصلاحات الأمان الموضحة في الأقسام السابقة، ودمجها في CI للتأكد من عدم عودة التسريبات.
  3. إعادة فحص الأمان بعد الإصلاحات للتأكد من إغلاق السطوح المعرضة والاستمرار في مراقبتها أثناء التشغيل.
