# UberFix.shop Audit Summary

## نطاق المراجعة
مراجعة مركزة لأبرز المخاطر الأمنية في تطبيق الويب ووظائف Supabase المرتبطة بنموذج طلب الصيانة السريع (QR) وتهيئة الطرف الثالث.
لم يتم تشغيل اختبارات أو بناء التطبيق في هذه الجولة.

## أهم الملاحظات الحرجة
1) **طلبات QR مجهولة بلا تحكم (No CAPTCHA/Rate Limit)**
   نموذج الطلب السريع يسمح بإرسال عدد غير محدود من الطلبات المجهولة دون Turnstile/ reCAPTCHA أو حد زمني. هذا يفتح الباب لهجمات سبام وDoS وتضخم التكلفة. يجب فرض CAPTCHA، حقل HoneyPot، وسياسة حد أقصى (مثلاً 3 طلبات/ساعة لكل IP+هاتف) عبر Edge Function قبل الإدراج. 【F:src/pages/QuickRequest.tsx†L1-L101】【F:src/components/forms/QuickRequestForm.tsx†L45-L253】

2) **مدخلات غير منقّحة تؤدي إلى XSS وتلويث البيانات**
   قيم `client_name` و`description` وغيرها تُدرج مباشرة في قاعدة البيانات دون sanitization أو قيود regex. أي HTML/JavaScript يمكن أن يُعرض لاحقًا في لوحات المشرف فيتسبب في XSS أو تشويه السجلات. يجب استخدام مكتبة تنظيف (DOMPurify) وقيود طول ورموز واضحة قبل الإدراج. 【F:src/components/forms/QuickRequestForm.tsx†L16-L253】

3) **رفع ملفات بلا تحقق أو حد فعلي**
   المرفقات تُرفع كما هي بدون فحص MIME، حد حجم فعّال، أو فحص صلاحية الصورة. يمكن رفع ملفات تنفيذية أو ZIP Bomb تؤدي لتعطيل التخزين. يلزم السماح فقط بأنواع صور معروفة (jpeg/png/webp)، فرض 20MB في الكود، والتحقق من المحتوى قبل الرفع. 【F:src/components/forms/QuickRequestForm.tsx†L99-L135】

4) **سجلات أخطاء مفصّلة في الواجهة**
   استخدام `console.log/console.error` لعرض روابط وظائف الحافة والرسائل الكاملة يعرض بنية النظام لأي زائر (Recon). يجب استبدالها بمسجّل مخصص يُعطّل في الإنتاج مع رسائل مستخدم عامة. 【F:src/pages/QuickRequest.tsx†L1-L101】【F:src/components/forms/QuickRequestForm.tsx†L138-L253】

5) **تسريب مفتاح Google Maps في الواجهة ووظائف الحافة**
   يوجد مفتاح Google Maps احتياطي في التهيئة، كما أن وظيفتي `get-maps-key` و`get-google-maps-key` تعيدان المفتاح مباشرة دون مصادقة أو قيود CORS. هذا يسمح بسحب المفتاح وإساءة استخدامه. 【F:src/config/maps.ts†L6-L34】【F:supabase/functions/get-maps-key/index.ts†L1-L47】【F:supabase/functions/get-google-maps-key/index.ts†L1-L32】

6) **نطاق وصول مفرط لقائمة المستخدمين**
   وظيفة `get-users` تستخدم SERVICE_ROLE وتسمح لأي مستخدم مصادق عليه بقراءة جميع المستخدمين عبر `auth.admin.listUsers`، متجاوزة مبدأ أقل الصلاحيات. يجب حصرها بدور إداري موثوق أو استبدالها باستعلام محكوم بـ RLS. 【F:supabase/functions/get-users/index.ts†L1-L55】

## توصيات عاجلة
- **حماية نموذج الطلب السريع:** إضافة Turnstile/Honeypot، حد أقصى 3 طلبات/ساعة لكل IP+هاتف عبر Edge Function، ورسائل خطأ عامة للمستخدم.
- **تنظيف وتحقق المدخلات:** تطبيق DOMPurify قبل الإدراج، إضافة regex وحدود طول في Zod schema، وعدم استخدام `dangerouslySetInnerHTML` لعرض البيانات.
- **تقييد رفع الملفات:** قبول أنواع صور محددة فقط، تطبيق حد 20MB فعلياً في الكود، رفض الملفات الفاشلة في فحص المحتوى، والنظر في فحص Malware على الخادم.
- **إزالة السجلات المفصلة:** استبدال console.* بمسجّل بيئي يرسل الأخطاء لخدمة مراقبة في الخلفية ويعرض رسائل عامة للمستخدمين.
- **إخفاء مفاتيح الخرائط:** إزالة أي مفاتيح ثابتة من الواجهة، وتقييد وظائف استرجاع المفاتيح بمصادقة واضحة أو بروكسي خرائط آمن مع قيود IP/الدومين.
- **مبدأ أقل الصلاحيات:** تقليص وظائف SERVICE_ROLE مثل `get-users` للحد الأدنى من الصلاحيات وربطها بسياسات RLS أو أدوار إدارية محددة.

## نقاط متابعة
- تشغيل أداة فحص الأمان `scripts/test-security.sh` ضمن CI للتأكد من غياب مفاتيح أو سجلات تصحيحية مستقبلية.
- إضافة اختبارات تكامل توثق توقعات التحكم في الوصول لهذه الوظائف لمنع تراجع الأمان مستقبلًا.
- توثيق مسار إصلاح كل ثغرة في تتبع المهام مع رابط إلى التصحيح ورقم التزام يثبت الإغلاق.
