# دورة حياة العميل من تسجيل الدخول حتى الأرشفة

يلخص هذا المستند رحلة العميل في UberFix.shop بدءًا من تسجيل الدخول، مرورًا بإدارة العقارات وطلبات الصيانة (السريعة والمصادق عليها)، وانتهاءً بالتقارير والأرشفة. يهدف إلى توحيد التسمية والواجهات والبيانات عبر الويب والموبايل.

## المرحلة 1 — إدارة العقارات (Property Management)
1. **تسجيل عقار جديد**
   - إدخال بيانات العقار الأساسية، الموقع على الخريطة، الصور، نوع الملكية، وربط العقار بالعميل (Customer ID).
   - توليد QR فوري مرتبط بالعقار وتخزين `property_id` في Supabase.
2. **تعديل العقار**
   - تعديل البيانات والموقع مع إعادة توليد QR إذا تغيّر الرابط.
   - تحديث الحالة (Active/Archived) وتسجيل النسخ في جدول Versioning.
3. **حذف العقار (Soft Delete)**
   - التحويل إلى Archived بدون حذف الطلبات أو QR المرتبطة.
4. **إدارة عدة عقارات**
   - إضافة عقارات متعددة لنفس العميل؛ كل عقار له QR ورقم خاص ويُختار عند كل طلب صيانة.

## المرحلة 2 — QR Code System (طلبات صيانة سريعة بدون مصادقة)
1. **إصدار QR للصيانة السريعة**
   - صيغة الرابط: `https://uberfix.shop/q/<property_id>/<secure_hash>` مع hash مميز وصلاحية مفتوحة.
2. **فتح الرابط بدون تسجيل دخول**
   - يعرض Quick Request Form لرفع الصور، كتابة الوصف، واختيار الخدمة ثم إرسال الطلب مباشرة.
3. **حماية الرابط والبيانات**
   - مراجعة RLS على `property_id` وضبط السرية/الحدود الزمنية والحد من الطلبات (Rate Limit + Turnstile/Honeypot).

## المرحلة 3 — متابعة طلب الصيانة السريعة
1. **تتبع الطلب عبر نفس QR**
   - صفحة Tracking تعرض حالات: Submitted → Under Review → On The Way → In Progress → Completed/Rejected.
   - تدفق فوري باستخدام Realtime Supabase مع صور قبل/بعد وخط زمني للحالة.

## المرحلة 4 — الصيانة العادية (Logged-in Request System)
1. **إنشاء طلب صيانة للعميل المسجل**
   - اختيار العقار، الخدمة، الأولوية، الموعد، ورفع الصور؛ يرتبط الطلب بـ `customer_id` ويحصل على `request_id`.
2. **دورة حياة الطلب الكاملة**
   - Submitted → Approved → Technician Assigned → Technician On The Way → In Progress → Paused/Awaiting Materials → Completed → Invoiced → Archived.
3. **المتابعة من لوحة التحكم**
   - Timeline للحالة، إشعارات (WhatsApp/SMS/Email)، تقارير SLA، وختم زمني لكل إجراء.

## المرحلة 5 — إعدادات العميل (Customer Settings)
- بيانات الحساب (الاسم، الهاتف، البريد، العنوان) وتفضيلات الصيانة (تذكير دوري، حد استقبال الفني، عروض خاصة، لغة العرض).
- إدارة العقارات (تعديل/حذف/إضافة/QR Codes) وإعدادات الإشعارات (بريد، واتساب، SMS، داخل التطبيق).
- الأمان (تغيير كلمة المرور، الجلسات، tokens).

## المشهد النهائي — الموديول الرسمي للعملاء
- توحيد الرحلة عبر الويب والموبايل مع حفظ السجل كاملًا من الإنشاء إلى الأرشفة.
- دعم التتبع الفوري، الفوترة، والأرشفة مع سياسات RLS وحماية الروابط العامة.

## الخطوات القادمة (Action Plan)
- تصميم واجهات Property Module و QR Quick Request Module و Maintenance Cycle و Customer Settings استنادًا إلى المخطط أعلاه.
- تغطية الاختبارات (E2E/وحدات) لكل حالة انتقال، خاصة فتح الروابط العامة وتتبع الحالة.
- دمج الحماية: CAPTCHA/Rate Limit، تنقية المدخلات، ضبط صلاحيات SERVICE_ROLE وتقييد رفع الملفات كما ورد في مراجعة الأمان.
